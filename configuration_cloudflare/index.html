<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Configuration de Cloudflare - Trackteur Arduino</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Configuration de Cloudflare";
        var mkdocs_page_input_path = "configuration_cloudflare.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Trackteur Arduino
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Accueil</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Configuration de Cloudflare</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#prerequis">Prérequis</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#quest-ce-que-cloudflare-tunnel">Qu'est-ce que Cloudflare Tunnel ?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#1-installation-de-cloudflared-sur-votre-serveur">1. Installation de cloudflared sur votre serveur</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-authentification-de-cloudflared-avec-votre-compte-cloudflare">2. Authentification de cloudflared avec votre compte Cloudflare</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#3-creation-et-configuration-du-tunnel">3. Création et configuration du Tunnel</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_traccar/">Installation de Traccar</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../programmation_liligo_a7670g/">Programmation du Liligo A7670G</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../creation_carte_sim_hologram/">Création de carte SIM - Hologram</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../fabrication_traceur_gps/">Fabrication du traceur GPS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation_vehicule/">Installation dans le véhicule</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Trackteur Arduino</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Configuration de Cloudflare</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="configuration-de-cloudflare-avec-des-tunnels">Configuration de Cloudflare avec des Tunnels</h1>
<p>La configuration de Cloudflare est essentielle pour sécuriser et optimiser l'accès à votre serveur Traccar. L'utilisation de Cloudflare Tunnels est particulièrement avantageuse pour exposer des services internes de manière sécurisée sans ouvrir de ports sur votre pare-feu.</p>
<h2 id="prerequis">Prérequis</h2>
<ul>
<li>Un compte Cloudflare actif.</li>
<li>Un nom de domaine enregistré et géré par Cloudflare.</li>
<li>Un serveur Linux avec Traccar installé et fonctionnant (généralement sur <code>localhost:8082</code>).</li>
</ul>
<h2 id="quest-ce-que-cloudflare-tunnel">Qu'est-ce que Cloudflare Tunnel ?</h2>
<p>Cloudflare Tunnel (anciennement Argo Tunnel) crée une connexion sécurisée et chiffrée entre votre serveur et le réseau Cloudflare, sans qu'il soit nécessaire d'ouvrir des ports entrants sur votre pare-feu. Votre serveur initie la connexion sortante vers Cloudflare, ce qui rend l'exposition de services beaucoup plus sécurisée.</p>
<h2 id="1-installation-de-cloudflared-sur-votre-serveur">1. Installation de <code>cloudflared</code> sur votre serveur</h2>
<p><code>cloudflared</code> est le démon client de Cloudflare Tunnel.</p>
<ol>
<li>
<p><strong>Téléchargez <code>cloudflared</code> :</strong></p>
<p>Pour les systèmes basés sur Debian/Ubuntu :
<code>bash
curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared</code>
<em>Adaptez l'URL de téléchargement à votre architecture si nécessaire (par exemple, <code>arm64</code> pour Raspberry Pi).</em></p>
</li>
<li>
<p><strong>Rendez l'exécutable :</strong>
    <code>bash
    sudo chmod +x /usr/local/bin/cloudflared</code></p>
</li>
<li>
<p><strong>Vérifiez l'installation :</strong>
    <code>bash
    cloudflared --version</code></p>
</li>
</ol>
<h2 id="2-authentification-de-cloudflared-avec-votre-compte-cloudflare">2. Authentification de <code>cloudflared</code> avec votre compte Cloudflare</h2>
<p>Cette étape va lier <code>cloudflared</code> à votre compte Cloudflare et générer un certificat.</p>
<ol>
<li><strong>Lancez la commande d'authentification :</strong>
    <code>bash
    cloudflared tunnel login</code></li>
<li>Une URL s'affichera dans votre terminal. Copiez-la et ouvrez-la dans votre navigateur web.</li>
<li>Connectez-vous à votre compte Cloudflare et sélectionnez le domaine que vous souhaitez utiliser pour le tunnel.</li>
<li>Une fois l'authentification réussie, un fichier de certificat (<code>cert.pem</code>) sera téléchargé et stocké dans le répertoire par défaut de <code>cloudflared</code> (généralement <code>~/.cloudflared/</code>).</li>
</ol>
<h2 id="3-creation-et-configuration-du-tunnel">3. Création et configuration du Tunnel</h2>
<ol>
<li>
<p><strong>Créez un nouveau tunnel :</strong>
    Donnez un nom unique à votre tunnel (par exemple, <code>traccar-tunnel</code>).
    <code>bash
    cloudflared tunnel create traccar-tunnel</code>
    Cette commande va créer le tunnel et générer un ID de tunnel (UUID) et un fichier de configuration pour celui-ci (par exemple, <code>~/.cloudflared/&lt;UUID&gt;.json</code>).</p>
</li>
<li>
<p><strong>Créez un fichier de configuration pour le tunnel (<code>config.yml</code>) :</strong>
    Ce fichier indique à <code>cloudflared</code> comment acheminer le trafic. Créez-le dans le même répertoire que votre certificat (<code>~/.cloudflared/</code>) ou dans un répertoire dédié au tunnel (par exemple, <code>/etc/cloudflared/traccar-tunnel/</code>).</p>
<p>```yaml</p>
<h1 id="cloudflaredconfigyml-ou-etccloudflaredtraccar-tunnelconfigyml">~/.cloudflared/config.yml ou /etc/cloudflared/traccar-tunnel/config.yml</h1>
<p>tunnel: <YOUR_TUNNEL_UUID>
credentials-file: /root/.cloudflared/<YOUR_TUNNEL_UUID>.json</p>
<p>ingress:
  # Règle pour l'interface web de Traccar (port 8082)
  - hostname: traccar.<YOUR_DOMAIN.COM>
    service: http://localhost:8082
    originRequest:
      noTLSVerify: true # Utilisez cette option si Traccar est en HTTP local
                       # Ou configurez HTTPS sur Traccar si vous avez un certificat local valide</p>
<p># Règle pour le port des appareils GPS (ex: OsmAnd sur 5055)
  # Il faut exposer ce port directement, car Cloudflare ne proxyfie pas les ports non-HTTP/HTTPS par défaut
  # Pour exposer des ports non-HTTP/HTTPS via Tunnel, il faut utiliser Cloudflare Spectrum (payant)
  # Une solution plus simple est de ne pas proxyfier ce sous-domaine via Cloudflare (nuage gris)
  - hostname: gps.<YOUR_DOMAIN.COM>
    service: tcp://localhost:5055 # Exemple pour OsmAnd
    # Si vous exposez directement (sans proxy Cloudflare) ce sous-domaine (gps.YOUR_DOMAIN.COM)
    # vers votre IP, il n'y a pas besoin de règle d'ingress ici pour le port 5055.
    # Le tunnel est principalement pour le trafic HTTP/HTTPS.</p>
<ul>
<li>service: http_status:404
```</li>
</ul>
<p><em>Remplacez <code>&lt;YOUR_TUNNEL_UUID&gt;</code> par l'ID de votre tunnel et <code>&lt;YOUR_DOMAIN.COM&gt;</code> par votre nom de domaine.</em></p>
</li>
</ol>
<h2 id="4-configuration-dns-dans-cloudflare">4. Configuration DNS dans Cloudflare</h2>
<p>Pour que votre sous-domaine pointe vers votre tunnel, vous devez créer un enregistrement CNAME dans votre tableau de bord Cloudflare.</p>
<ol>
<li><strong>Connectez-vous à votre tableau de bord Cloudflare.</strong></li>
<li>Sélectionnez votre nom de domaine.</li>
<li>Dans le menu de gauche, allez dans la section <strong>DNS</strong>.</li>
<li>
<p>Cliquez sur <strong>Ajouter un enregistrement</strong> (<code>Add record</code>).</p>
<ul>
<li><strong>Type</strong>: <code>CNAME</code></li>
<li><strong>Nom</strong>: <code>traccar</code> (ou le nom de votre sous-domaine)</li>
<li><strong>Cible</strong>: L'adresse fournie par <code>cloudflared</code> lors de la création du tunnel. Elle se termine généralement par <code>cfargotunnel.com</code>. Par exemple, <code>abcd.cfargotunnel.com</code>.</li>
<li><strong>Proxy status</strong>: Assurez-vous que le nuage orange est activé (Proxied).</li>
</ul>
</li>
<li>
<p>Cliquez sur <strong>Enregistrer</strong>.</p>
</li>
</ol>
<p><em>Note : Si vous exposez des ports non-HTTP/HTTPS (comme 5055 pour les appareils GPS) sans Cloudflare Spectrum, vous devrez créer un enregistrement <code>A</code> pointant directement vers votre IP de serveur pour un sous-domaine comme <code>gps.YOUR_DOMAIN.COM</code>, et vous assurer que ce sous-domaine </em><em>n'est pas proxyfié</em><em> (nuage gris).</em></p>
<h2 id="5-execution-de-cloudflared-comme-service-systeme">5. Exécution de <code>cloudflared</code> comme service système</h2>
<p>Pour que votre tunnel reste actif, même après un redémarrage du serveur, exécutez <code>cloudflared</code> en tant que service système.</p>
<ol>
<li><strong>Installez le service :</strong>
    <code>bash
    sudo cloudflared tunnel install</code></li>
<li><strong>Démarrez le service :</strong>
    <code>bash
    sudo systemctl start cloudflared</code></li>
<li><strong>Vérifiez le statut du service :</strong>
    <code>bash
    sudo systemctl status cloudflared</code></li>
<li><strong>Assurez-vous qu'il démarre au boot :</strong>
    <code>bash
    sudo systemctl enable cloudflared</code></li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>Votre serveur Traccar est maintenant accessible de manière sécurisée via Cloudflare Tunnel. Cette configuration offre une couche de sécurité supplémentaire en masquant l'adresse IP de votre serveur et en utilisant les protections DDoS et le pare-feu applicatif web (WAF) de Cloudflare.</p>
<p>N'oubliez pas de mettre à jour votre <code>/opt/traccar/conf/traccar.xml</code> pour que Traccar écoute sur <code>localhost</code> si ce n'est pas déjà le cas, et configurez vos appareils GPS pour qu'ils pointent vers <code>traccar.&lt;YOUR_DOMAIN.COM&gt;</code> (ou <code>gps.&lt;YOUR_DOMAIN.COM&gt;</code> si vous avez configuré un sous-domaine non proxyfié pour les ports non-HTTP/HTTPS).</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Accueil"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../installation_traccar/" class="btn btn-neutral float-right" title="Installation de Traccar">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../installation_traccar/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
