<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>Configuration de Cloudflare - Trackteur Arduino</title>
<link href="../css/theme.css" rel="stylesheet"/>
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "Configuration de Cloudflare";
        var mkdocs_page_input_path = "configuration_cloudflare.md";
        var mkdocs_page_url = null;
      </script>
<!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Trackteur Arduino
        </a><div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="..">Accueil</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../BOM/">BOM (Liste des composants)</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation_docker/">Déploiement des serveurs Traccar</a>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal current" href="#">Configuration de Cloudflare</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#prerequis">Prérequis</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#0-achat-du-nom-de-domaine-sur-cloudflare">0. Achat du nom de domaine sur Cloudflare</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#01-creer-un-compte-cloudflare">0.1 Créer un compte Cloudflare</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#02-rechercher-et-acheter-un-domaine">0.2 Rechercher et acheter un domaine</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#03-verifier-la-configuration-dns">0.3 Vérifier la configuration DNS</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#04-activer-les-fonctionnalites-gratuites">0.4 Activer les fonctionnalités gratuites</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#1-creer-les-tunnels-cloudflare-pour-chaque-serveur">1. Créer les tunnels Cloudflare (pour chaque serveur)</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#11-creer-le-fichier-env">1.1 Créer le fichier .env</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#12-creer-le-tunnel-sur-cloudflare">1.2 Créer le tunnel sur Cloudflare</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#13-demarrer-les-services">1.3 Démarrer les services</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#2-creer-le-worker-cloudflare">2. Créer le Worker Cloudflare</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#21-creer-le-worker">2.1 Créer le Worker</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#22-configurer-le-code-du-worker">2.2 Configurer le code du Worker</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#23-configurer-les-variables-denvironnement">2.3 Configurer les variables d'environnement</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#24-configurer-le-domaine-personnalise">2.4 Configurer le domaine personnalisé</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#3-configurer-le-traceur-gps">3. Configurer le traceur GPS</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#notes-utiles">Notes utiles</a>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../creation_carte_sim_hologram/">Création de carte SIM Hologram</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../programmation_liligo_a7670g/">Programmation du Lilygo A7670G</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fabrication_traceur_gps/">Fabrication du traceur GPS</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation_vehicule/">Installation dans le véhicule</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Trackteur Arduino</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href=".."></a></li>
<li class="breadcrumb-item active">Configuration de Cloudflare</li>
<li class="wy-breadcrumbs-aside">
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="configuration-de-cloudflare">Configuration de Cloudflare</h1>
<p>Ce guide explique comment acheter un nom de domaine, configurer Cloudflare pour exposer vos serveurs Traccar et créer le Worker qui réplique les données GPS vers tous les serveurs.</p>
<h2 id="prerequis">Prérequis</h2>
<ul>
<li>Un compte Cloudflare actif (gratuit)</li>
<li>Une carte de crédit pour l'achat du domaine</li>
<li>Serveurs Traccar déployés et fonctionnels</li>
</ul>
<h2 id="0-achat-du-nom-de-domaine-sur-cloudflare">0. Achat du nom de domaine sur Cloudflare</h2>
<p>Cloudflare propose l'enregistrement de domaines au prix coûtant (sans marge), ce qui en fait une option économique.</p>
<h3 id="01-creer-un-compte-cloudflare">0.1 Créer un compte Cloudflare</h3>
<ol>
<li>Aller sur <a href="https://dash.cloudflare.com/sign-up">https://dash.cloudflare.com/sign-up</a></li>
<li>Créer un compte avec votre email</li>
<li>Valider l'email de confirmation</li>
</ol>
<h3 id="02-rechercher-et-acheter-un-domaine">0.2 Rechercher et acheter un domaine</h3>
<ol>
<li>Dans le dashboard, aller dans <strong>Domain Registration</strong> → <strong>Register Domains</strong></li>
<li>Rechercher le nom de domaine souhaité (ex: <code>trackteur.cc</code>, <code>montracker.com</code>)</li>
<li>Vérifier la disponibilité et le prix</li>
<li><code>.com</code> : ~$10/an</li>
<li><code>.cc</code> : ~$10/an</li>
<li><code>.io</code> : ~$35/an</li>
<li>Cliquer sur <strong>Purchase</strong></li>
<li>Remplir les informations WHOIS (contact)</li>
<li>Cloudflare masque automatiquement vos infos personnelles (WHOIS privacy gratuit)</li>
<li>Entrer les informations de paiement</li>
<li>Confirmer l'achat</li>
</ol>
<h3 id="03-verifier-la-configuration-dns">0.3 Vérifier la configuration DNS</h3>
<p>Après l'achat, le domaine est automatiquement configuré avec les DNS Cloudflare:</p>
<ol>
<li>Aller dans <strong>Websites</strong> → Sélectionner votre domaine</li>
<li>Aller dans <strong>DNS</strong> → <strong>Records</strong></li>
<li>Vous devriez voir les nameservers Cloudflare actifs</li>
</ol>
<h3 id="04-activer-les-fonctionnalites-gratuites">0.4 Activer les fonctionnalités gratuites</h3>
<p>Dans les paramètres du domaine, activez:</p>
<ol>
<li><strong>SSL/TLS</strong> → Mode <strong>Full (strict)</strong></li>
<li><strong>Security</strong> → <strong>Bot Fight Mode</strong> (optionnel)</li>
<li><strong>Speed</strong> → <strong>Auto Minify</strong> (optionnel)</li>
</ol>
<h2 id="architecture">Architecture</h2>
<div class="mermaid">flowchart LR
    GPS[Traceur GPS] --&gt;|Données| W[Worker Cloudflare&lt;br/&gt;endpoint.domaine.com]
    W --&gt;|Réplication| T1[Tunnel 1&lt;br/&gt;serveur1.domaine.com]
    W --&gt;|Réplication| T2[Tunnel 2&lt;br/&gt;serveur2.domaine.com]
    W --&gt;|Réplication| T3[Tunnel 3&lt;br/&gt;serveur3.domaine.com]
    T1 --&gt; S1[Serveur Traccar 1]
    T2 --&gt; S2[Serveur Traccar 2]
    T3 --&gt; S3[Serveur Traccar 3]</div>
<h2 id="1-creer-les-tunnels-cloudflare-pour-chaque-serveur">1. Créer les tunnels Cloudflare (pour chaque serveur)</h2>
<p>Répétez ces étapes pour chaque serveur Traccar.</p>
<h3 id="11-creer-le-fichier-env">1.1 Créer le fichier <code>.env</code></h3>
<p>Le service <code>cloudflared</code> a besoin d'un token de tunnel pour s'authentifier.</p>
<pre class="highlight"><code class="language-bash">touch .env</code></pre>
<p>Ajoutez votre token de tunnel :</p>
<pre class="highlight"><code>TUNNEL_TOKEN=&lt;VOTRE_TOKEN_DE_TUNNEL_CLOUDFLARE&gt;</code></pre>
<h3 id="12-creer-le-tunnel-sur-cloudflare">1.2 Créer le tunnel sur Cloudflare</h3>
<ol>
<li>Sur le dashboard Cloudflare, vérifiez que votre domaine est géré par Cloudflare</li>
<li>Rendez-vous dans <strong>Zero Trust → Networks → Tunnels</strong></li>
<li>Cliquez sur <strong>Add a tunnel / Create a tunnel</strong></li>
<li>Choisissez <strong>Docker</strong> comme méthode d'installation</li>
<li>Copiez le token fourni et collez-le dans votre fichier <code>.env</code></li>
<li>Dans <strong>Public Hostnames</strong>, créez un enregistrement :</li>
<li><strong>Subdomain</strong> : <code>serveur1</code> (ou <code>serveur2</code>, <code>serveur3</code>, etc.)</li>
<li><strong>Domain</strong> : Votre domaine</li>
<li><strong>Service</strong> : <code>HTTP</code> et <code>http://traccar:8082</code></li>
<li>Enregistrez le tunnel</li>
</ol>
<h3 id="13-demarrer-les-services">1.3 Démarrer les services</h3>
<pre class="highlight"><code class="language-bash">sudo docker-compose up -d</code></pre>
<h2 id="2-creer-le-worker-cloudflare">2. Créer le Worker Cloudflare</h2>
<p>Le Worker reçoit les données GPS du traceur et les réplique vers tous les serveurs Traccar simultanément.</p>
<h3 id="21-creer-le-worker">2.1 Créer le Worker</h3>
<ol>
<li>Sur le dashboard Cloudflare, allez dans <strong>Workers et Pages</strong></li>
<li>Cliquez sur <strong>Create Worker</strong></li>
<li>Donnez un nom au Worker (ex: <code>traccar-replicator</code>)</li>
<li>Cliquez sur <strong>Deploy</strong></li>
</ol>
<h3 id="22-configurer-le-code-du-worker">2.2 Configurer le code du Worker</h3>
<ol>
<li>Cliquez sur <strong>Edit code</strong></li>
<li>Remplacez le contenu par :</li>
</ol>
<pre class="highlight"><code class="language-javascript">export default {
  async fetch(request, env, ctx) {
    const targets = [
      env.TRACCAR_A,
      env.TRACCAR_B,
      env.TRACCAR_C,
    ];

    const url = new URL(request.url);
    const method = request.method;

    const queryString = url.search; // garde ?id=...&amp;lat=...
    const body = await request.arrayBuffer();

    const headers = new Headers(request.headers);
    headers.delete("Host");
    headers.delete("Content-Length");

    const promises = targets.map(async (baseUrl) =&gt; {
      if (!baseUrl) {
        return { target: baseUrl, ok: false, error: "missing target" };
      }

      const targetUrl = baseUrl + queryString;

      try {
        const resp = await fetch(targetUrl, {
          method,
          headers,
          body: method === "GET" ? undefined : body,
        });
        return { target: targetUrl, ok: resp.ok, status: resp.status };
      } catch (e) {
        return { target: targetUrl, ok: false, error: String(e) };
      }
    });

    ctx.waitUntil(
      (async () =&gt; {
        const results = await Promise.all(promises);
        console.log("Traccar fan-out results", JSON.stringify(results));
      })()
    );

    return new Response("OK\n", { status: 200, headers: { "Content-Type": "text/plain" } });
  },
};</code></pre>
<ol>
<li>Cliquez sur <strong>Save and Deploy</strong></li>
</ol>
<h3 id="23-configurer-les-variables-denvironnement">2.3 Configurer les variables d'environnement</h3>
<ol>
<li>Allez dans l'onglet <strong>Settings</strong> du Worker</li>
<li>Dans <strong>Variables and Secrets</strong>, ajoutez les variables suivantes :</li>
</ol>
<table>
<thead>
<tr>
<th>Type</th>
<th>Nom</th>
<th>Valeur</th>
</tr>
</thead>
<tbody>
<tr>
<td>Text</td>
<td><code>TRACCAR_A</code></td>
<td><code>https://serveur1.votredomaine.com</code></td>
</tr>
<tr>
<td>Text</td>
<td><code>TRACCAR_B</code></td>
<td><code>https://serveur2.votredomaine.com</code></td>
</tr>
<tr>
<td>Text</td>
<td><code>TRACCAR_C</code></td>
<td><code>https://serveur3.votredomaine.com</code></td>
</tr>
</tbody>
</table>
<ol>
<li>Cliquez sur <strong>Save</strong></li>
</ol>
<h3 id="24-configurer-le-domaine-personnalise">2.4 Configurer le domaine personnalisé</h3>
<ol>
<li>Allez dans l'onglet <strong>Domains &amp; Routes</strong> du Worker</li>
<li>Cliquez sur <strong>Add</strong> → <strong>Custom Domain</strong></li>
<li>Entrez le sous-domaine pour le point d'entrée GPS (ex: <code>gps.votredomaine.com</code>)</li>
<li>Cliquez sur <strong>Add Domain</strong></li>
</ol>
<h2 id="3-configurer-le-traceur-gps">3. Configurer le traceur GPS</h2>
<p>Dans la configuration du traceur (fichier <code>config.h</code>), utilisez l'URL du Worker :</p>
<pre class="highlight"><code class="language-cpp">#define TRACCAR_SERVER_URL "https://gps.votredomaine.com"</code></pre>
<p>Le traceur enverra ses données au Worker, qui les répliquera automatiquement vers tous les serveurs Traccar.</p>
<h2 id="notes-utiles">Notes utiles</h2>
<ul>
<li>Le Worker répond toujours <code>OK</code> au traceur, même si certains serveurs sont indisponibles</li>
<li>Les logs du Worker (accessibles dans <strong>Observability</strong>) montrent le résultat de chaque réplication</li>
<li>Vous pouvez ajouter ou retirer des serveurs en modifiant les variables d'environnement</li>
</ul>
</div>
</div><footer>
<div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-left" href="../installation_docker/" title="Déploiement des serveurs Traccar"><span class="icon icon-circle-arrow-left"></span> Previous</a>
<a class="btn btn-neutral float-right" href="../creation_carte_sim_hologram/" title="Création de carte SIM Hologram">Next <span class="icon icon-circle-arrow-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span><a href="../installation_docker/" style="color: #fcfcfc">« Previous</a></span>
<span><a href="../creation_carte_sim_hologram/" style="color: #fcfcfc">Next »</a></span>
</span>
</div>
<script src="../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "..";</script>
<script src="../js/theme_extra.js"></script>
<script src="../js/theme.js"></script>
<script src="../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>
